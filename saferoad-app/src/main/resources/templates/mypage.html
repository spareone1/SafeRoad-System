<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(
        pageTitle='마이페이지',
        bodyClass='page-mypage',
        content=~{::#page-content},
        styles=~{::#page-styles},
        scripts=~{::#page-scripts}
      )}">

<head>
    <th:block id="page-styles">
        <style>
            .message-box {
                padding: 14px 16px;
                border-radius: 12px;
                margin-bottom: 16px;
                text-align: center;
                font-weight: 600;
            }
            .message-box.success {
                background-color: #f0fdf4;
                border: 1px solid #bbf7d0;
                color: #166534;
            }
            .message-box.error {
                background-color: #fff1f2;
                border: 1px solid #ffdde0;
                color: #d9304e;
            }
        </style>
    </th:block>
</head>

<body>

<main id="page-content">
    <section class="container">
        <h2 class="section__title">마이페이지</h2>

        <div th:if="${success}" class="message-box success" th:text="${success}"></div>
        <div th:if="${error}" class="message-box error" th:text="${error}"></div>

        <div class="mypage-grid" style="display:grid; gap:var(--gap); grid-template-columns:0.9fr 1.1fr;"
             th:object="${userDto}">

            <aside class="profile" style="display:grid; gap:18px;">
                <div class="card card--pad">
                    <div class="profile-head" style="display:flex; align-items:center; gap:16px;">
                        <div class="avatar" style="width:92px; height:92px; border-radius:999px; border:6px solid var(--c-primary-weak); background:linear-gradient(135deg,#e5edff,#eef2ff); display:grid; place-items:center; font-weight:700; color:#0a2a8a;"
                             th:text="*{initial}">HK</div>
                        <div>
                            <div class="profile-name" style="font-weight:800;" th:text="*{name}">홍길동</div>
                            <div class="profile-meta" style="color:var(--c-muted); font-size:14px;">
                                <span th:text="|아이디 *{userid}|">아이디 hong123</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card card--pad">
                    <div class="block-title" style="font-weight:800; margin-bottom:12px;">최근 신고 이력</div>

                    <div th:if="${#lists.isEmpty(myReports)}" style="text-align:center; color:#999; padding:20px 0;">
                        신고 내역이 없습니다.
                    </div>

                    <div class="report-list" style="display:grid; gap:12px;" th:unless="${#lists.isEmpty(myReports)}">
                        <div class="report-item" th:each="report : ${myReports}" style="display:flex; gap:12px; align-items:center;">

                            <div class="report-thumb" style="width:72px; height:72px; border-radius:12px; overflow:hidden; border:1px solid var(--c-border); flex-shrink:0;">
                                <img th:src="|http://alalstkdl123.cafe24.com:15531/${report.imageloc}|"
                                     alt="장애물 이미지"
                                     style="width:100%; height:100%; object-fit:cover;" />                            </div>

                            <div style="flex:1; min-width:0;">
                                <div class="report-title" style="font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
                                     th:text="${report.obstacleName}">장애물 이름</div>
                                <div class="report-desc" style="font-size:13px; color:#666; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
                                     th:text="${report.location}">위치 정보</div>

                                <div class="report-meta" style="color:var(--c-muted); font-size:12px; display:flex; align-items:center; gap:6px;">
                                    <span th:text="${#temporals.format(report.createdAt, 'yyyy.MM.dd')}">2025.10.14</span>
                                    <span class="report-meta__sep">·</span>

                                    <span th:switch="${report.state.name()}"
                                          class="badge"
                                          th:classappend="${report.state.name() == 'completed' ? 'badge--done' : (report.state.name() == 'processing' ? 'badge--progress' : 'badge--pending')}"
                                          style="height:20px; font-size:11px; padding:0 6px;">
                                        <span th:case="'completed'">완료</span>
                                        <span th:case="'processing'">처리중</span>
                                        <span th:case="*">대기</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <div class="card card--pad card--account">
                <h3 class="section-title-sm" style="margin-top:0;">계정 정보</h3>
                <form class="form" th:action="@{/mypage/update}" method="post" th:object="${userDto}">
                    <div class="field">
                        <label class="label" for="userid">아이디</label>
                        <input class="input" id="userid" name="userid" type="text" th:value="*{userid}" readonly />
                    </div>
                    <div class="field">
                        <label class="label" for="name">이름</label>
                        <input class="input" id="name" th:field="*{name}" />
                    </div>
                    <div class="grid-2">
                        <div class="field">
                            <label class="label" for="pw1">새 비밀번호</label>
                            <input class="input" id="pw1" name="password" type="password" placeholder="변경 시 입력" autocomplete="new-password" th:field="*{password}" />
                        </div>
                        <div class="field">
                            <label class="label" for="pw2">비밀번호 확인</label>
                            <input class="input" id="pw2" name="passwordConfirm" type="password" placeholder="변경 시 입력" autocomplete="new-password" th:field="*{passwordConfirm}" />
                        </div>
                    </div>

                    <div class="actions actions--left">
                        <button class="btn btn--blue" type="submit">저장</button>
                        <button class="btn btn--ghost" type="reset">취소</button>
                    </div>
                </form>

                <button type="button" class="btn-withdraw">회원 탈퇴</button>
            </div>
        </div>
    </section>
</main>

<div class="modal" id="withdrawModal" role="dialog" aria-modal="true"
     aria-labelledby="wd-title" aria-describedby="wd-desc" aria-hidden="true">
    <div class="card card--pad popup-card" role="document">
        <h3 id="wd-title" style="margin:0 0 8px;">SafeRoad 회원 탈퇴 확인</h3>
        <p id="wd-desc" style="margin:0 0 6px; font-size:18px;">정말로 회원 탈퇴를 진행하시겠습니까?</p>
        <div style="font-size:14px; color:#475569; margin-bottom:12px;">
            탈퇴 시 이용 중인 서비스와 신고 이력이 모두 삭제되며 복구할 수 없습니다.
        </div>
        <div class="actions">
            <button class="btn" type="button" data-close-modal>취소</button>
            <a class="btn btn--danger" th:href="@{/withdraw/proceed}">탈퇴 진행</a>
        </div>
    </div>
</div>

<th:block id="page-scripts">
    <script th:inline="javascript">
        (function () {
            const openBtn = document.querySelector('.btn-withdraw');
            const modal = document.getElementById('withdrawModal');
            if (!openBtn || !modal) return;

            let lastFocused = null;

            modal.addEventListener('click', (e) => {
                const popup = modal.querySelector('.popup-card');
                if (popup && !popup.contains(e.target)) {
                    closeModal();
                    return;
                }
                const closeTrigger = e.target.closest('[data-close-modal], .js-close');
                if (closeTrigger) {
                    e.preventDefault();
                    closeModal();
                }
            }, { passive: false });

            function openModal() {
                lastFocused = document.activeElement;
                modal.setAttribute('aria-hidden', 'false');
                document.body.classList.add('modal-open');
                const focusable = modal.querySelector('[data-close-modal], .btn, a, button, [href], input, select, textarea');
                (focusable || modal).focus();
            }

            function closeModal() {
                modal.setAttribute('aria-hidden', 'true');
                document.body.classList.remove('modal-open');
                if (lastFocused) lastFocused.focus();
            }

            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') {
                    e.preventDefault();
                    closeModal();
                }
            });

            openBtn.addEventListener('click', openModal);

        })();
    </script>
</th:block>

</body>
</html>