<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(
        pageTitle='로그인',
        bodyClass='state-guest',
        content=~{::#page-content},
        styles=~{::#page-styles},
        scripts=~{::#page-scripts}
      )}">

<head>
    <th:block id="page-styles">
        <style>
            .error-message {
                background-color: #fff1f2;
                border: 1px solid #ffdde0;
                color: #d9304e;
                padding: 14px 16px;
                border-radius: 12px;
                margin-bottom: 16px;
                text-align: center;
                font-weight: 600;
            }
        </style>
    </th:block>
</head>

<body>

<main id="page-content">
    <section class="container">
        <h2 class="section__title">로그인</h2>

        <form class="form card card--pad" id="login-form">

            <div id="error-message-box" class="error-message" hidden></div>

            <div class="field">
                <label class="label" for="userid">아이디</label>
                <input class="input" id="userid" name="userid" type="text" autocomplete="username" required />
            </div>

            <div class="field">
                <label class="label" for="password">비밀번호</label>
                <input class="input" id="password" name="password" type="password" autocomplete="current-password" required />
            </div>

            <label class="checkbox">
                <input type="checkbox" name="remember-me" />
                로그인 상태 유지
            </label>
            <div class="actions" style="justify-content:center">
                <button class="btn btn--blue" type="submit">로그인하기</button>
            </div>
            <p class="section__desc">
                아직 계정이 없으신가요?
                <a th:href="@{/register}" style="color:var(--c-blue); font-weight:700">회원가입</a>
            </p>
        </form>
    </section>
</main>

<th:block id="page-scripts">
    <script th:inline="javascript">
        (function() {
            const loginForm = document.getElementById('login-form');
            const errorBox = document.getElementById('error-message-box');

            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const userid = document.getElementById('userid').value;
                    const password = document.getElementById('password').value;

                    errorBox.hidden = true;

                    try {
                        const response = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                userid: userid,
                                password: password
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            localStorage.setItem('userName', data.name);
                            localStorage.setItem('userRole', data.role);

                            window.location.href = '/';
                        } else {
                            errorBox.textContent = data.error || '로그인에 실패했습니다.';
                            errorBox.hidden = false;
                        }

                    } catch (error) {
                        errorBox.textContent = '로그인 요청 중 오류가 발생했습니다.';
                        errorBox.hidden = false;
                    }
                });
            }
        })();
    </script>
</th:block>

</body>
</html>